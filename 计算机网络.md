# 计算机网络

## 概述

网络把主机连接起来，而互联网是把多种不同的网络连接起来，因此，互联网是网络的网络。

### ISP

互联网服务提供商ISP可以从互联网管理机构获得许多IP地址同时拥有通信线路以及路由器等联网设备，个人或机构向ISP缴纳一定的费用就可以接入互联网。

### 主机间的通信方式

- 客户-服务器（c/s）：客户是服务的请求方，服务器是服务的提供方。
- 对等（p2p）：不区分客户和服务器。



## 电路与分组交换

1. 电路交换

   电路交换用于电话通信系统，两个用户要通信之前需要建立一条专用的物理链路，并且在整个通信过程中始终占用该链路，由于通信的过程中不可能一直在使用传输链路，因此电路交换对线路的利用率很低，往往不到10%。

2. 分组交换

   每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路上同时传输多个分组互相不会影响，因此在同一条传输线路上允许同时传输多个分组，也就是说分组交换不需要占用传输线路。

## 时延

总时延=排队时延+处理时延+传输时延+传播时延

1. **排队时延**

   分组在路由器的输入队列和输出队列中排队等待的时间，取决于网络当前的通信量

2. 处理时延

   主机或路由器收到分组时进行处理所需要的时间。例如分析首部，从分组中提取数据，进行差错检验或者查找适当的路由等。

3. 传输时延

   主机或路由器传输数据帧所需要的时间。
   $$
   delay = I(bit)/v(bit/s)
   $$
   

   其中I表示数据帧的长度，v表示传输速率。

4. 传播时延

   电磁波在信道中传播所需要花费的时间，电磁波传播的速度接近光速。
   $$
   deley = I(m)/v(m/s)
   $$
   
其中I表示信道长度，v表示电磁波在信道上的传播速度。

## 计算机网络体系结构

![image-20200924204601223](/Users/yangxiansheng/笔记/images/image-20200924204601223.png)

1. **五层协议**

   - 应用层：为特定应用程序提供数据传输服务，例如HTTP、DNS等协议，数据单位为报文。

   - 传输层：为进程提供通用数据传输服务，由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议，传输层包括两种协议：

     - 传输控制协议TCP：提供面向连接，可靠的数据传输服务，数据单位为报文段。

     - 用户数据报协议UDP：提供无连接，尽最大努力交付的数据传输服务，数据单位为用户数据报。

       > TCP主要提供完整性服务，UDP主要提供及时性服务

   - 网络层：为主机提供数据传输服务，而传输层协议是为主机中的进程提供数据传输服务，网络层把传输层传递下来的报文段或者用户数据报封装成分组。

   - 物理层：在传输媒体上传输数据比特流，物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

2. OSI

   其中表示层和会话层作用如下：

   - 表示层：数据压缩、加密以及数据描述，这使得应用程序不必关心在各台主机中数据内部格式不同的问题。
   - 会话层：建立及管理会话。

   > 五层协议没有表示层和会话层，而是将这些功能留给应用程序开发者处理

3. TCP/IP

   只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。

   TCP/IP体系结构不严格遵循OSI分层概念，应用层可能回直接使用IP层或者网络接口。

   ![image-20200924221736302](/Users/yangxiansheng/笔记/images/image-20200924221736302.png)

4. 数据在各层之间的传递过程

   在向下的过程中，需要添加下层协议所需的首部或者尾部，而在向上的过程中不断拆开首部和尾部。

   路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也不需要传输层和应用层。



## 物理层

#### 通信方式

​	根据信息在传输线上的传送方向，分为以下三种通信方式：

- 单工通信：单向传输
- 半双工通信：双向交替传输
- 全双工通信：双向同时传输

#### 带通调制

​	模拟信号是连续的信号，数字信号是离散的信号。带通调制把数字信号转换为模拟信号。

![image-20201125224742483](/Users/yangxiansheng/笔记/images/image-20201125224742483.png)

## 链路层

#### 基本问题

1. 封装成帧

将网络层传下来的分组添加首部和尾部，用户标记帧的开始和结束。

![image-20201125224943423](/Users/yangxiansheng/笔记/images/image-20201125224943423.png)

2. 透明传输

   透明表示一个实际存在的事物看起来好像不存在一样。

   帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束为止就会被错误的判定，需要在数据部分出现首部尾相同内容前面插入转义字符。如果数据部分出现转义字符，那么就在转义字符前面再加上一个转义字符。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容就是转义字符，用户察觉不到转义字符的存在（透明传输，察觉不到即透明）

3. 差错检测

   目前数据链路层广泛使用循环冗余检验（CRC）来检查比特差错。

#### 信道分类

1. 广播信道

   一对多通信，一个节点发送的数据能够被广播信道上所有节点接收到。

   所有节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突。

2. 点对点信道

   一对一通信，因为不会发生碰撞，所以比较简单，使用PPP协议进行控制。

#### MAC地址

​	MAC地址是链路层地址，长度为6字节，用于唯一标示网络适配器（网卡）。

一台主机有多少个网络适配器就有多少个MAC地址。

#### 局域网

​	局域网是一种典型的广播信道，主要特点是网络为一个单位所拥有，且地理范围和站点数量有限。

#### 交换机

​	交换机具有自学习能力，学习的是交换表的内容，交换表中存储着MAC地址到接口的映射，因此交换机是一种即插即用设备，不需要手动配置交换表内容。

## 网络层

​	网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上提供简单灵活的、无连接的、尽最大努力交付的数据报服务。

​	使用IP协议，可以把异构的物理网络连接起来，使得在网络层看来好像是一个统一的网络。

​	与IP协议配套使用的还有三个协议：

- 地址解析协议APR（Address Resolution Protocol）
- 网际控制报文协议ICMP
- 网际组管理协议IGMP

#### IP数据报格式

![image-20201125235655319](/Users/yangxiansheng/笔记/images/image-20201125235655319.png)

- 版本：有4和6两个值（IPV4和IPV6）
- 首部长度：占4位，因此最大值为15。
- 区分服务：用来获得更好的服务，一般不使用。
- 总长度：包括首部长度和数据部分长度。
- 生存时间：TTL，是为了防止无法交付的数据报一直在互联网中兜圈子。以路由器跳数为单位，当TTL为0时丢弃数据报。
- 协议：指出携带的数据应该交给那个协议处理，例如ICMP、TCP、UDP等。
- 首部检验和：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
- 标识：在数据报长度过长从而发生分片的情况下，相同数据报不同分片具有相同的标识符。
- 片偏移：和标识符一起，用于发生了分片的情况，片偏移的单位为8字节。

![image-20201126000451857](/Users/yangxiansheng/笔记/images/image-20201126000451857.png)

#### IP地址编址方式

IP地址的编址方式经历了三个历史阶段：

- 分类
- 子网划分
- 无分类

1. ##### 分类

   由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且时固定的。

   IP地址::={<网络号>,<主机号>}

   ![image-20201126001653141](/Users/yangxiansheng/笔记/images/image-20201126001653141.png)

2. ##### 子网划分

   通过在主机号字段中拿一部分作为子网号，把两级IP地址划分为三级IP地址。

   IP地址::={<网络号>,<子网号>,<主机号>}

   要使用子网，必须配置子网掩码，一个B类地址的默认子网掩码为255.255.0.0，如果B类地址的子网独占两个比特，那么子网掩码为11111111 11111111 11000000 00000000即255.255.192.0。

   外部网络看不到子网的存在。

3. ##### 无分类

   ​	无分类编址CIDR消除了传统A类、B类和C类地址以及划分子网的概念，使用网络前缀和主机号来对IP地址进行编码，网络前缀的长度可以根据需要变化。

   IP地址::={<网络前缀号>,<主机号>}

   ​	CIDR的记法上采用在IP地址后面加上网络前缀长度的方法，例如128.12.35.7/20表示前20位为网络前缀。

   ​	一个CIDR地址块中有很多地址，一个CIDR表示的网络就可以表示原来的很多个网络，并且在路由器中只需要一个路由就可以代替原来多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为**路由聚合**，也称为**构成超网**。

   ​	在路由表中的项目由“网络前缀”和“吓一跳地址”组成，在查找时可能匹配不止一个结果，应当采取最长前缀匹配来确定应该匹配哪一个。

#### 地址解析协议ARP

​	网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP数据报的源地址和目的地址始终不变，而MAC地址随着链路的改变而改变。

![image-20201126004442606](/Users/yangxiansheng/笔记/images/image-20201126004442606.png)

ARP实现由IP地址得到MAC地址。

![image-20201126004528392](/Users/yangxiansheng/笔记/images/image-20201126004528392.png)

每个主机都有一个ARP高速缓存，里面有本局域网上的各主机和路由器的IP地址到MAC地址的映射表。

如果主机A知道主机B的ip地址，但是ARP高速缓存中没有该IP地址到MAC地址的映射，此时主机A通过广播的方式发送ARP请求分组，主机B收到该请求之后发松ARP响应分组给主机A告知其MAC地址，随后主机A向其高速缓存中写入主机B的IP地址到MAC地址的映射。

#### 网际控制报文协议ICMP

​	ICMP是为了更有效的转发IP数据报和提高交付成功的机会，它封装在IP数据报中，但是不属于高层协议。

![image-20201126010510142](/Users/yangxiansheng/笔记/images/image-20201126010510142.png)

ICMP报文分为差错报告报文和询问报文。

![image-20201126010832811](/Users/yangxiansheng/笔记/images/image-20201126010832811.png)

1. PING

   ping是ICMP的一个重要应用，主要用来测试两台主机之间的连通性。

   ping的原理是通过向目的主机发送ICMO Echo请求报文，目的主机收到之后会发送Echo回答报文，ping会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

2. Traceroute

   Traceroute是ICMP的另一个应用，用来跟踪一个分组从原点到终点的路径.

   Traceroute发送的IP数据报封装的是无法交付的UDP用户数据报，并由目的主机发送终点不可达差错报告报文。

   - 源主机向目的主机发送一连串的IP数据报。第一个数据报P1的生存时间TTL设置为1，当P1到达路径上的第一个路由器R1时，R1收下它并把TTL减1，此时TTL=0，R1就把P1丢弃，并向源主机发送一个ICMP时间超过差错报告报文，此时源主机知道了第一个到达的路由器；
   - 源主机接着发送第二个数据报P2，并把TTL设置为2，此时第二个接收到P2的路由器就会丢弃P2，并向源主机发送一个ICMP时间超过差错报文，此时源主机知道了第二个到达的路由器。
   - 不断执行这样的步骤，知道最后一个数据报刚刚到达目标主机，主机不转发数据，但是因为数据报封装的是无法交付的UDP，因此目的主机要向源主机发送ICMP终点不可达差错报告报文。
   - 最终源主机知道了到达目的主机所经过的路由器IP地址以及到达每个路由器的往返时间。











## 传输层

​	网络层只把分组发送到目的主机，但真正通信的并不是主机而是主机中的进程。传输层提供了进程间的通信，传输层向高层用户屏蔽了下面网络层的细节，使应用程序看起来像是两个传输层实体之间有一条端到端的逻辑通信通道。

### UDP和TCP的特点

- 用户数据协议报（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对应用程序传下来的报文不合并也不拆分，只是添加了UDP首部），支持一对一、一对多、多对一、多对多的交互通信。
- 传输控制协议TCP（Transmission Control Protocol）是面向连接的，提供可靠交付，有流量控制、拥塞控制、提供全双工通信、面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每条Tcp连接只能是点对点的（一对一）。

### UDP首部格式

![image-20201122231844798](/Users/yangxiansheng/笔记/images/image-20201122231844798.png)

首部字段只有8个字节，包括源端口、目的端口、长度、检验和。12字节的伪首部是为了计算检验和临时添加的。

### TCP的首部格式

![image-20201122232025322](/Users/yangxiansheng/笔记/images/image-20201122232025322.png)

- 序号：对字节流进行编号，例如序号为301，表示第一个字节编号为301，如果携带的数据长度为100字节，那么下一个报文段的序号应为401。
- 确认号：期望下一个报文段的序号
- 数据偏移：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度
- 确认ACK：当ACK=1时确认号字段有效；否则无效。TCP规定，在建立连接之后所有传送的报文段ACK必须置为1；
- 同步SYN：在连接建立时用来同步序号，当SYN=1，ACK=0时表示这是一个连接请求报文段，若对方同意建立连接，则相应报文中ACK=1，SYN=1；
- 终止FIN：用来释放一个连接，当FIN=1时，表示此报文段的发送方数据已经发送完毕，并要求释放连接。
- 窗口：窗口值作为接收方让发送方设置其发送窗口的依据，之所以要有这个限制是因为接收方的数据缓存空间是有限的。

### TCP的三次握手

![image-20201122233230311](/Users/yangxiansheng/笔记/images/image-20201122233230311.png)

1. 首先服务器端处于LISTEN（监听）状态，等待客户端的请求
2. 客户端向服务端发送请求报文，SYN=1，ACK=0，选择一个初始序号（seq）x
3. 服务器端收到连接请求报文，如果同意建立连接，则向客户端发送确认报文，SYN=1，ACK=1，确认号为x+1，同时也选择一个初始序号y。
4. 客户端收到服务器端的确认报文，还要向服务器端发出确认，确认号为y+1，序号为x+1
5. 服务器端收到客户端的确认后，连接建立。

#### 三次握手的原因

​	第三次握手是为了防止失效的连接请求到达服务器，让服务器打开错误的连接请求。

​	客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间服务器才能收到连接请求并返回连接确认，但是如果在这期间，客户端等待超时之后重新发送了一个连接请求，没有第三次握手确认的话（因为客户端只会确认第二个重新发送的连接请求），服务器会建立两个连接。或者客户端干脆不请求服务器资源了，没有第三次确认的话，服务器就直接建立连接等待客户端发送数据，这是服务器的资源就被浪费了。

### TCP四次挥手

![image-20201122235734665](/Users/yangxiansheng/笔记/images/image-20201122235734665.png)

以下描述不涉及序号和确认号、ACK，因为序号和确认号规则简单，ACK在连接建立之后都为1；

1. 客户端发送连接释放报文，FIN=1。
2. 服务器端收到之后发出确认，此时TCP处于半关闭状态，服务器端可以向客户端发送数据，但是客户端不能向服务器端发送数据。
3. 当服务器不再需要连接时，发送连接释放报文，FIN=1；
4. 客户端收到释放报文后发出确认，进入TIME-WAIT状态，等待2MSL（最大报文存活时间）后释放连接。
5. 服务器端收到客户端的确认后释放连接。

#### 四次挥手的原因

​	客户端发送了FIN连接释放报文后，服务器收到这个报文，就进入了CLOSE-WAIT状态，这个状态是为了让服务端发送还未传送完成的数据，传送完毕之后，服务器就会发送FIN连接释放报文。

#### TIME_WAIT

​	客户端收到服务器的FIN释放连接报文之后就进入此状态，此时并是不直接进入CLOSE状态，还需要等待2MSL（最大报文存活时间）

> 进入TIME-WAIT状态的理由
>
> - 确保最后一个确认报文能够到达，如果服务器端没有接收到客户端发送的确认报文，那么服务端就会重新发送一个连接释放请求报文，客户端等待一段时间就是为了能够接收到重发的报文并且响应。
> - 等待一段时间是为了让此次连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接的请求报文。

#### TCP可靠传输

​	TCP使用超时重传来确保可靠传输，如果一个已经发送的报文超时时间内没有接收到接收方发送的确认报文，那么就会重新发送这个报文。

​	一个报文段从发送再到接收到确认所经过的时间称为往返时间RTT。

#### TCP滑动窗口

​	窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各自有一个窗口，接收方通过TCP报文段中的窗口字段高速发送方自己的窗口大小，发送方根据这个值和其他信息设置自己的窗口大小。

​	发送窗口内的字节都允许被发送，接受窗口内的字节都允许被接收，如果发送窗口左部的字节已经发送并且收到了确认，那么就将发送窗口向右滑动一定距离，直到左部第一个字节不是已发送并且收到确认的状态，接受窗口类似，左部字节已经发送确认交付主机，就向右滑动接收窗口。

​	接收窗口只会对窗口内最后一个按序到达的字节确认，例如接收到的字节为{31,34,35}，其中31按序到达，而34、35不是，因此只对31进行确认，发送方得到一个字节的确认之后，就知道这个字节前面的字节都已经被接收了。

![image-20201126235732335](/Users/yangxiansheng/笔记/images/image-20201126235732335.png)

#### TCP流量控制

​	流量控制是为了控制发送方的发送速率，保证接收方来得及接收。

​	接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率，将窗口字段置为0，则发送方不能发送数据。

#### TCP拥塞控制

如果网络出现拥塞，分组将丢失，此时发送方继续重传，从而使得网络拥塞程度更高，因此当出现网络拥塞时，应该控制发送方的发送速率。这一点和流量控制很像，但是出发点不同，流量控制是为了让接收方及时接收，拥塞控制是为了降低整个网络的拥塞程度。

![image-20201127000234476](/Users/yangxiansheng/笔记/images/image-20201127000234476.png)

TCP主要通过四个算法来进行拥塞控制：慢开始、拥塞避免、快重传、快恢复。













## 应用层

#### 域名系统

​	DNS是一个分布式数据库，提供了主机名和IP地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。

​	域名具有层次结构，从上到下依次为：根域名、顶级域名、二级域名。

![image-20201127000628485](/Users/yangxiansheng/笔记/images/image-20201127000628485.png)

DNS可以使用UDP或者TCP进行传输，使用的端口号都为53，大多数情况下DNS用UDP进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性，在两种情况下会使用TCP进行传输。

- 如果返回的响应超过512字节，（UDP最大只支持512字节的数据）。
- 区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）。

#### 文件传输协议

FTP使用TCP进行连接，它需要两个连接来传送一个文件：

- 控制连接：服务器打开端口号21等待客户端的连接，客户端主动建立连接，通过这个连接，客户端发送命令给服务器，并传回服务器的应答。
- 数据连接：用来传送一个文件数据。

根据数据连接是否主动建立，FTP有主动和被动两种模式：

- 主动模式：服务器端主动建立连接，其中服务器端的端口号为20，客户端的端口号随机，但是必须大于1024，因为0-1023是熟知端口号。

![image-20201127175153650](/Users/yangxiansheng/笔记/images/image-20201127175153650.png)

- 被动模式：客户端主动建立连接，其中客户端的端口由客户端指定，服务器端端口随机。

![image-20201127175315405](/Users/yangxiansheng/笔记/images/image-20201127175315405.png)

#### 动态主机配置协议

​	DHCP（Dynamic Host Configuration Protocol）提供了即插即用的联网方式，用户不再需要手动配置IP地址等信息。

​	DHCP配置的内容不仅是IP地址，还包括子网掩码、网关IP地址。

​	DHCP工作流程如下：

1. 客户端发送Discover报文，该报文的目的地址是255.255.255.67，源地址为0.0.0.0:68，被放入UDP中，该报文被广播到同一个子网的所有主机上，如果客户端和DHCP服务器不在同一个子网，就需要使用中继器

 
